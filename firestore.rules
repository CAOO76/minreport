rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Verify if user is a Super Admin
    function isSuperAdmin() {
      return request.auth != null && 
        (
          request.auth.token.role == 'SUPER_ADMIN' ||
          request.auth.token.email == 'admin@minreport.com'
          // Removed database lookup to prevent circular dependency/recursion loops on user profile reads
        );
    }

    // User Profiles Collection
    match /users/{userId} {
      // Super Admins can do everything
      allow read, write: if isSuperAdmin();
      
      // Regular users can only read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;

      // [LOGIN FLOW SUPPORT] Allow looking up a user by email (Limit 1)
      allow list: if request.query.limit <= 1; 
      
      // Allow users to update their own LAST ACTIVE ACCOUNT only (context switching)
      allow update: if request.auth != null && request.auth.uid == userId && 
                    request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastActiveAccountId']);
    }

    // ACCOUNTS / TENANTS DATA
    match /accounts/{accountId} {
      // Owner can read
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        isSuperAdmin()
      );
      
      // [LOGIN FLOW SUPPORT] Allow public read of account details (Name/Type) for the login selector
      allow get: if true;

      // Only Super Admin can write/create accounts via backend (or scripts)
      allow write: if isSuperAdmin();
    }

    // Audit Logs Collection (Append Only for Admin)
    match /admin_audit_logs/{logId} {
      allow create, read: if isSuperAdmin();
    }

    // Branding & Global Settings
    match /settings/branding {
      allow read: if true; // Publicly readable for UI consistency
      allow write: if isSuperAdmin();
    }

    // Tenants Management (Requests)
    match /tenants/{tenantId} {
      allow read, write: if isSuperAdmin();
    }

    // User Inbox (Messages)
    match /users/{userId}/inbox/{messageId} {
      allow read, write: if isSuperAdmin();
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // System Plugins (Dynamic Registry)
    match /plugins/{pluginId} {
      allow read: if request.auth != null; // Authenticated users/admins can read
      allow write: if isSuperAdmin();      // Only Super Admin can manage plugins
    }

    // SDK Versions Management
    match /admin_sdk_versions/{versionId} {
      allow read, write: if isSuperAdmin();
    }
  }
}
